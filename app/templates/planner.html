{% extends "base.html" %}
{% block title %}Planner | Medical Tourism AI{% endblock %}

{% block head_extra %}
<style>
  /* ================================
     Medical Gradient Background
  ==================================*/
  body {
    min-height: 100vh;
    background:
      radial-gradient(1200px 800px at 10% 10%, rgba(13,110,253,.18), transparent 55%),
      radial-gradient(900px 700px at 90% 20%, rgba(32,201,151,.16), transparent 50%),
      radial-gradient(1000px 900px at 50% 90%, rgba(102,16,242,.12), transparent 55%),
      linear-gradient(135deg, #f8fbff 0%, #f3fbf8 50%, #f8f5ff 100%);
    overflow-x: hidden;
  }

  /* Subtle medical cross pattern */
  body::before {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    opacity: 0.12;
    background-image:
      linear-gradient(transparent 0, transparent 18px, rgba(13,110,253,.25) 18px, rgba(13,110,253,.25) 20px, transparent 20px),
      linear-gradient(90deg, transparent 0, transparent 18px, rgba(13,110,253,.25) 18px, rgba(13,110,253,.25) 20px, transparent 20px);
    background-size: 64px 64px;
    mask-image: radial-gradient(circle at 50% 30%, rgba(0,0,0,1), rgba(0,0,0,0) 70%);
  }

  /* Floating gradient blobs */
  .bg-blob {
    position: fixed;
    width: 520px;
    height: 520px;
    border-radius: 999px;
    filter: blur(40px);
    opacity: .25;
    z-index: -1;
    animation: floaty 10s ease-in-out infinite;
  }
  .blob-1 { left: -140px; top: -140px; background: rgba(13,110,253,.55); }
  .blob-2 { right: -160px; top: 40px; background: rgba(32,201,151,.55); animation-delay: -2s; }
  .blob-3 { left: 30%; bottom: -220px; background: rgba(102,16,242,.45); animation-delay: -4s; }

  @keyframes floaty {
    0%,100% { transform: translate(0,0) scale(1); }
    50% { transform: translate(20px, -18px) scale(1.05); }
  }

  /* Glass container */
  .glass-shell {
    background: rgba(255,255,255,.65);
    border: 1px solid rgba(255,255,255,.55);
    box-shadow: 0 10px 35px rgba(0,0,0,.08);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 18px;
  }

  .page-title {
    letter-spacing: .2px;
  }

  .subtitle {
    color: rgba(33,37,41,.7);
  }

  /* ================================
     Chat Styles (Your original)
  ==================================*/
  .msg-user {
    padding: 12px;
    background: rgba(248,249,250,.9);
    border: 1px solid #dee2e6;
    border-radius: 10px;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .msg-assistant {
    padding: 14px;
    background: rgba(255,255,255,.92);
    border: 1px solid #dee2e6;
    border-radius: 12px;
    white-space: pre-wrap;
    word-break: break-word;
    overflow: visible;
  }

  .assistant-scroll {
    max-height: 420px;
    overflow-y: auto;
  }

  .assistant-scroll::-webkit-scrollbar { width: 10px; }
  .assistant-scroll::-webkit-scrollbar-thumb {
    background: rgba(13,110,253,.25);
    border-radius: 999px;
  }

  .assistant-scroll::-webkit-scrollbar-track { background: transparent; }

  .searchbar .form-control {
    border-radius: 12px 0 0 12px !important;
  }

  .searchbar .btn {
    border-radius: 0 12px 12px 0 !important;
  }
</style>
{% endblock %}

{% block content %}

<!-- Background blobs -->
<div class="bg-blob blob-1"></div>
<div class="bg-blob blob-2"></div>
<div class="bg-blob blob-3"></div>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-9 col-xl-8">
      <div class="glass-shell p-4 p-md-5">

        <div class="text-center mb-4">
          <h1 class="page-title mb-1">Agentic Medical Tourism Search</h1>
          <div class="subtitle small">
            Ask about procedures, costs, safety, hospitals, and countries.
          </div>
        </div>

        <div id="history" class="mb-3"></div>

        <div class="input-group mb-1 searchbar">
          <input id="query" class="form-control" placeholder="Ask about procedures, costs, countries..." />
          <button class="btn btn-primary" onclick="submitQuery()">
            Search üîé
          </button>
        </div>

        <div class="text-muted small mt-2">
          Example: "Lasik in Dubai"
        </div>

      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block body_extra %}
<script>
  // =========================================================
  // Drop-in change: frontend sends a "mode" flag
  // - "auto": backend decides
  // - "clarification": we are answering a clarifying question
  // =========================================================
  window.currentMode = "auto";

  function wordCount(text) {
    const words = (text || "").trim().match(/\S+/g);
    return words ? words.length : 0;
  }

  function applyAssistantScroll(el, text, threshold = 300) {
    if (wordCount(text) > threshold) el.classList.add("assistant-scroll");
    else el.classList.remove("assistant-scroll");
  }

  function getLastAssistantText(data) {
    if (data && typeof data.clarification_question === "string" && data.clarification_question.trim()) {
      return data.clarification_question.trim();
    }

    const msgs = data?.messages;
    if (Array.isArray(msgs) && msgs.length > 0) {
      for (let i = msgs.length - 1; i >= 0; i--) {
        const m = msgs[i];
        if (m && (m.role === "assistant" || m.type === "ai") && typeof m.content === "string") {
          const t = m.content.trim();
          if (t) return t;
        }
      }
      const last = msgs[msgs.length - 1];
      if (last && typeof last.content === "string" && last.content.trim()) return last.content.trim();
    }

    // If hospitals exist, don't dump full JSON‚ÄîUI will render cards.
    if (Array.isArray(data?.hospitals) && data.hospitals.length > 0) {
      return "Here are some hospital options. Select one to continue.";
    }

    return JSON.stringify(data, null, 2);
  }

  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[c]));
  }

  function renderHospitals(hospitals, onSelect) {
    const wrapper = document.createElement("div");
    wrapper.className = "mt-3";

    const row = document.createElement("div");
    row.className = "row g-3";
    wrapper.appendChild(row);

    hospitals.forEach((h, idx) => {
      const id = h.id || h.hospital_id || `hosp_${idx}`;

      const col = document.createElement("div");
      col.className = "col-12";

      const card = document.createElement("div");
      card.className = "card shadow-sm border-0";
      card.style.borderRadius = "14px";

      const body = document.createElement("div");
      body.className = "card-body";

      const name = h.name || "Hospital";
      const city = h.city || h.location || "";
      const country = h.country || h.destination_country || "";
      const rating = (h.rating != null) ? `‚≠ê ${h.rating}` : "";
      const price = (h.approx_price_usd != null) ? `$${h.approx_price_usd} approx` : "";
      const why = h.why || h.reason || "";

      body.innerHTML = `
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div>
            <div class="fw-semibold fs-5">${esc(name)}</div>
            <div class="text-muted small">${esc([city, country].filter(Boolean).join(", "))}</div>
          </div>
          <div class="text-end">
            ${rating ? `<div class="small">${esc(rating)}</div>` : ""}
            ${price ? `<div class="small text-muted">${esc(price)}</div>` : ""}
          </div>
        </div>
        ${why ? `<div class="mt-2 small">${esc(why)}</div>` : ""}
        <div class="mt-3 d-flex gap-2 flex-wrap">
          <button class="btn btn-primary btn-sm">Select</button>
          <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#details_${esc(id)}">
            Details
          </button>
        </div>
        <div class="collapse mt-2" id="details_${esc(id)}">
          <div class="small text-muted">
            ${esc(JSON.stringify(h, null, 2))}
          </div>
        </div>
      `;

      // Wire up Select
      const selectBtn = body.querySelector("button.btn.btn-primary");
      selectBtn.addEventListener("click", () => onSelect({ ...h, id }));

      card.appendChild(body);
      col.appendChild(card);
      row.appendChild(col);
    });

    return wrapper;
  }

  async function selectHospital(hospital) {
    const history = document.getElementById("history");

    const responseBlock = document.createElement("pre");
    responseBlock.className = "msg-assistant mb-4";
    responseBlock.textContent = `Selected: ${hospital.name || hospital.id}. Finding flight options...`;
    history.appendChild(responseBlock);

    try {
      const res = await fetch("/api/select_hospital", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ hospital_id: hospital.id }),
      });

      const data = await res.json();

      // For now: just show assistant text; later you can render flights like hospitals.
      // If hospital results exist ‚Üí render as cards
      if (data && Array.isArray(data.hospitals)) {
          renderHospitals(data.hospitals, selectHospital);
          window.currentMode = "auto";
      } else {
          const text = getLastAssistantText(data);
          responseBlock.textContent = text;
          applyAssistantScroll(responseBlock, text);

          if (data && data.needs_clarification === true) {
              window.currentMode = "clarification";
          } else {
              window.currentMode = "auto";
          }
      }

      // After hospital selection, we are no longer in clarification mode.
      window.currentMode = "auto";
    } catch (err) {
      responseBlock.textContent = "Error contacting server for hospital selection.";
      window.currentMode = "auto";
    }

    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  async function submitQuery() {
    const input = document.getElementById("query");
    const q = input.value.trim();
    if (!q) return;

    const history = document.getElementById("history");

    const userBlock = document.createElement("pre");
    userBlock.className = "msg-user mb-2";
    userBlock.textContent = "You: " + q;
    history.appendChild(userBlock);

    // Create a container for assistant output so we can append cards under it
    const assistantContainer = document.createElement("div");
    assistantContainer.className = "mb-4";
    history.appendChild(assistantContainer);

    const responseBlock = document.createElement("pre");
    responseBlock.className = "msg-assistant mb-2";
    responseBlock.textContent = "Searching...";
    assistantContainer.appendChild(responseBlock);

    input.value = "";

    try {
      const res = await fetch("/api/plan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query: q, mode: window.currentMode }),
      });

      const data = await res.json();

      // 1) Always show assistant text
      const text = getLastAssistantText(data);
      responseBlock.textContent = text;
      applyAssistantScroll(responseBlock, text);

      // 2) If hospitals exist, render cards
      if (Array.isArray(data?.hospitals) && data.hospitals.length > 0) {
        const cards = renderHospitals(data.hospitals, selectHospital);
        assistantContainer.appendChild(cards);
      }

      // 3) Mode switching for clarification
      if (data && data.needs_clarification === true) {
        window.currentMode = "clarification";
      } else {
        window.currentMode = "auto";
      }
    } catch (err) {
      responseBlock.textContent = "Error contacting server.";
      window.currentMode = "auto";
    }

    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  document.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      const active = document.activeElement;
      if (active && active.id === "query") submitQuery();
    }
  });
</script>
{% endblock %}